<!DOCTYPE html>
<html class="writer-html5" lang="fr" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>server &mdash; Documentation Seleenix 1.0.0</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=05dadb3a"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/translations.js?v=d99ca74e"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Seleenix
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" aria-label="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Seleenix</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Seleenix</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Code du module</a></li>
      <li class="breadcrumb-item active">server</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Code source de server</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Cet extrait de code est une implémentation du serveur d&#39;un application de chat. </span>
<span class="sd">Il inclut des classes pour gérer les permissions utilisateurs, gérer les exceptions, et intéragir avec la base de donnée Mysql. </span>
<span class="sd">Le serveur écoute les connexions entrantes, authentifie les utilisateurs, et leur permet d&#39;envoyer et recevoir des messages dans différents salons de discussion.</span>

<span class="sd">La gestion des permissions se fait en grande partie localement, mais dès qu&#39;il y a modification il y a restauration depuis la base de donnée Mysql.</span>

<span class="sd">L&#39;utilisation de code ANSI permet de correctement positionner le terminal afin d&#39;éviter de rencontrer des artéfacts visuels,</span>
<span class="sd">on ne peut malheureusement gérer tous ces artifacts.</span>



<span class="sd">Exemple d&#39;utilisation:</span>
<span class="sd">python server.py --port 1234</span>


<span class="sd">Entrées:</span>
<span class="sd">- port: Le port sur lequel le serveur écoute les connexions entrantes.</span>

<span class="sd">Déroulement:</span>
<span class="sd">1. Le serveur créé un socket et le bind à lui-même et un port (spécifié en arguments).</span>
<span class="sd">2. Le serveur commence à écouter les connexions entrantes.</span>
<span class="sd">3. Quand un client se connecte, le serveur reçoit un payload contenant les informations suivantes:</span>
<span class="sd">- challenge: une suite logique permettant de vérifier authenticié du client</span>
<span class="sd">- username: le nom d&#39;utilisateur du client</span>
<span class="sd">- password: le mot de passe du client</span>
<span class="sd">4. Le serveur vérifie les informations d&#39;authentification en les comparant à une base de données MySQL.</span>
<span class="sd">5. Si les informations sont valides, le serveur ajoute le socket du client à un dictionnaire de clients connectés. (socket_list)</span>
<span class="sd">6. Le serveur démarre un nouveau thread pour gérer l&#39;interaction du client.</span>
<span class="sd">7. Le client peut envoyer et recevoir des messages dans différents salons de discussion.</span>
<span class="sd">8. Le serveur stocke les messages dans une base de données MySQL pour une récupération future.</span>
<span class="sd">9. Le serveur diffuse les messages reçus à tous les clients dans le même salon de discussion.</span>
<span class="sd">10. Le serveur gère les commandes telles que rejoindre un salon, s&#39;abonner à un salon, et expulser / bannir des utilisateurs.</span>
<span class="sd">11. Le serveur arrête le thread d&#39;interaction et ferme le socket du client lorsque le client se déconnecte.    </span>


<span class="sd">Sorties:</span>
<span class="sd">- Messages reçus des clients sont diffusés à d&#39;autres clients dans le même salon de discussion.</span>
<span class="sd">- Le serveur gère les commandes et met à jour les capacités de l&#39;utilisateur et les salons autorisés en conséquence.</span>
<span class="sd">- Le serveur stocke les messages dans une base de données MySQL pour une récupération future.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">_socket</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">colorama</span> <span class="kn">import</span> <span class="n">init</span><span class="p">,</span> <span class="n">Fore</span><span class="p">,</span> <span class="n">Back</span><span class="p">,</span> <span class="n">Style</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mysql.connector</span>
<span class="kn">from</span> <span class="nn">mysql.connector</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="kn">import</span> <span class="nn">keyboard</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;scapy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span> <span class="c1"># pour éviter les log de warning</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="n">conf</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">builtins</span> <span class="k">as</span> <span class="nn">bt</span>

<span class="c1"># gestion des droits utilisateurs</span>
<div class="viewcode-block" id="user_capabilities">
<a class="viewcode-back" href="../server.html#server.user_capabilities">[docs]</a>
<span class="k">class</span> <span class="nc">user_capabilities</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe permettant de gérer localement les droits des utilisateurs.</span>
<span class="sd">    Ces droits sont stockés dans une base de donnée Mysql et sont restaurés dans le classe à chaque modification.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        object: classe parente</span>
<span class="sd">        </span>
<span class="sd">    Attributes:</span>
<span class="sd">        username: le nom d&#39;utilisateur</span>
<span class="sd">        allowed_room: les salons autorisés</span>
<span class="sd">        is_admin: les droits d&#39;administrateur</span>
<span class="sd">        all_rooms: tous les salons disponibles</span>
<span class="sd">        current_room: le salon actuel</span>
<span class="sd">        </span>
<span class="sd">    Methods:</span>
<span class="sd">        __init__: constructeur de la classe</span>
<span class="sd">        __str__: méthode pour afficher les attributs de la classe</span>
<span class="sd">        __repr__: méthode pour afficher les attributs de la classe</span>
<span class="sd">        __eq__: méthode pour comparer les attributs de la classe</span>
<span class="sd">        __ne__: méthode pour comparer les attributs de la classe</span>
<span class="sd">        is_admin: méthode pour vérifier si l&#39;utilisateur est administrateur</span>
<span class="sd">        username: méthode pour récupérr le nom d&#39;utilisateur</span>
<span class="sd">        allowed_room: méthode pour récupérer les salons autorisés</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None   </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
    
    
    <span class="n">all_rooms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;General&quot;</span><span class="p">,</span><span class="s2">&quot;Blabla&quot;</span><span class="p">,</span><span class="s2">&quot;Comptabilité&quot;</span><span class="p">,</span> <span class="s2">&quot;Informatique&quot;</span><span class="p">,</span> <span class="s2">&quot;Marketing&quot;</span><span class="p">]</span>
    <span class="n">current_room</span> <span class="o">=</span> <span class="s2">&quot;General&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">allowed_room</span><span class="p">,</span> <span class="n">is_admin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructeur de la classe user_capabilities</span>
<span class="sd">        </span>
<span class="sd">        Classe permettant de gérer localement les droits des utilisateurs.</span>
<span class="sd">        Ces droits sont stockés dans une base de donnée Mysql et sont restaurés dans le classe à chaque modification.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            object: classe parente</span>
<span class="sd">            </span>
<span class="sd">        Attributes:</span>
<span class="sd">            username: le nom d&#39;utilisateur</span>
<span class="sd">            allowed_room: les salons autorisés</span>
<span class="sd">            is_admin: les droits d&#39;administrateur</span>
<span class="sd">            all_rooms: tous les salons disponibles</span>
<span class="sd">            current_room: le salon actuel</span>
<span class="sd">            </span>
<span class="sd">        Methods:</span>
<span class="sd">            __init__: constructeur de la classe</span>
<span class="sd">            __str__: méthode pour afficher les attributs de la classe</span>
<span class="sd">            __repr__: méthode pour afficher les attributs de la classe</span>
<span class="sd">            __eq__: méthode pour comparer les attributs de la classe</span>
<span class="sd">            __ne__: méthode pour comparer les attributs de la classe</span>
<span class="sd">            is_admin: méthode pour vérifier si l&#39;utilisateur est administrateur</span>
<span class="sd">            username: méthode pour récupérer le nom d&#39;utilisateur</span>
<span class="sd">            allowed_room: méthode pour récupérer les salons autorisés</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            None   </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__allowed_room</span> <span class="o">=</span> <span class="n">allowed_room</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_admin</span> <span class="o">=</span> <span class="n">is_admin</span>
        
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__username</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allowed_room</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allowed_room</span>
    
    <span class="nd">@allowed_room</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">allowed_room</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__allowed_room</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_admin</span>
    
    <span class="nd">@is_admin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__is_admin</span> <span class="o">=</span> <span class="n">value</span>
        

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;username: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">, allowed_room: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_room</span><span class="si">}</span><span class="s2">, is_admin: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;username: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">, allowed_room: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_room</span><span class="si">}</span><span class="s2">, is_admin: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">username</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_room</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">allowed_room</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">username</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_room</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">allowed_room</span></div>


<span class="c1"># exception permettant de prévenir de l&#39;envoie d&#39;un &quot;bye&quot; général</span>
<div class="viewcode-block" id="LogoutBroadcast">
<a class="viewcode-back" href="../server.html#server.LogoutBroadcast">[docs]</a>
<span class="k">class</span> <span class="nc">LogoutBroadcast</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="IncorrectPassword">
<a class="viewcode-back" href="../server.html#server.IncorrectPassword">[docs]</a>
<span class="k">class</span> <span class="nc">IncorrectPassword</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="BannedUser">
<a class="viewcode-back" href="../server.html#server.BannedUser">[docs]</a>
<span class="k">class</span> <span class="nc">BannedUser</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="LimitConnectionIP">
<a class="viewcode-back" href="../server.html#server.LimitConnectionIP">[docs]</a>
<span class="k">class</span> <span class="nc">LimitConnectionIP</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>




<div class="viewcode-block" id="arg_parse">
<a class="viewcode-back" href="../server.html#server.arg_parse">[docs]</a>
<span class="k">def</span> <span class="nf">arg_parse</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction permettant de parser les arguments passés en ligne de commande</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        args: les arguments passés en ligne de commande</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Serveur de chat&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Port sur lequel le serveur écoute les connexions entrantes&#39;</span><span class="p">)</span>
    <span class="c1">#args = parser.parse_args()</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></div>

      
        
<span class="c1"># Configuration du serveur</span>
<span class="c1">#host = &quot;0.0.0.0&quot;</span>
<span class="c1">#port = arg_parse().port -&gt; déplace dans __main__</span>
<span class="k">global</span> <span class="n">connected</span>
<span class="k">global</span> <span class="n">socket_list</span>
<span class="k">global</span> <span class="n">user_caps</span>
<span class="n">connected</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">socket_list</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionnaire contenant les sockets des clients</span>
<span class="n">user_caps</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionnaire contenant les droits des utilisateurs</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AES_KEY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1"># récupérer depuis les variables d&#39;environnements</span>
<span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;AES_IV&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1">#récupérer depuis les variables d&#39;environnements</span>
<span class="n">mysql_passwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MYSQL_PASSWD&#39;</span><span class="p">]</span> <span class="c1">#récupérer depuis les variables d&#39;environnements</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>

<span class="c1"># Liste de pseudos par défaut</span>
<span class="n">default_pseudo</span> <span class="o">=</span>  <span class="p">[</span><span class="s2">&quot;Nosferatu&quot;</span><span class="p">,</span><span class="s2">&quot;BlackBird&quot;</span><span class="p">,</span><span class="s2">&quot;Pleiades&quot;</span><span class="p">,</span><span class="s2">&quot;Hyades&quot;</span><span class="p">,</span><span class="s2">&quot;Undertaker&quot;</span><span class="p">,</span><span class="s2">&quot;BloodyReina&quot;</span><span class="p">,</span><span class="s2">&quot;Wehrwolf&quot;</span><span class="p">,</span><span class="s2">&quot;LaughingFox&quot;</span><span class="p">,</span><span class="s2">&quot;SnowWitch&quot;</span>\
    <span class="p">,</span><span class="s2">&quot;Gunslinger&quot;</span><span class="p">,</span><span class="s2">&quot;Sagittarius&quot;</span><span class="p">,</span><span class="s2">&quot;Cyclops&quot;</span><span class="p">,</span><span class="s2">&quot;Melusine&quot;</span><span class="p">,</span><span class="s2">&quot;Bluebell&quot;</span><span class="p">,</span><span class="s2">&quot;Verethragna&quot;</span><span class="p">,</span><span class="s2">&quot;Hualien&quot;</span><span class="p">,</span><span class="s2">&quot;Milan&quot;</span><span class="p">,</span><span class="s2">&quot;Baldanders&quot;</span><span class="p">,</span><span class="s2">&quot;Catoblepas&quot;</span><span class="p">,</span><span class="s2">&quot;Banshee&quot;</span>\
    <span class="p">,</span><span class="s2">&quot;Grimalkin&quot;</span><span class="p">,</span><span class="s2">&quot;Bandersnatch&quot;</span><span class="p">,</span><span class="s2">&quot;Jabberwock&quot;</span><span class="p">,</span><span class="s2">&quot;Dullahan&quot;</span><span class="p">,</span><span class="s2">&quot;Kirschblüte&quot;</span><span class="p">,</span><span class="s2">&quot;BlackDog&quot;</span><span class="p">,</span><span class="s2">&quot;Falke&quot;</span><span class="p">,</span><span class="s2">&quot;Fafnir&quot;</span><span class="p">,</span><span class="s2">&quot;Helianthus&quot;</span><span class="p">,</span><span class="s2">&quot;Walpurgis&quot;</span><span class="p">,</span><span class="s2">&quot;Griffin&quot;</span><span class="p">,</span>\
    <span class="s2">&quot;Manticore&quot;</span><span class="p">,</span><span class="s2">&quot;Artemis&quot;</span><span class="p">,</span><span class="s2">&quot;Cato&#39;Nine&quot;</span><span class="p">,</span><span class="s2">&quot;MarchHare&quot;</span><span class="p">,</span><span class="s2">&quot;Sirius&quot;</span><span class="p">,</span><span class="s2">&quot;Leukosia&quot;</span><span class="p">,</span><span class="s2">&quot;Gunmetalstorm&quot;</span><span class="p">,</span><span class="s2">&quot;LaBete&quot;</span><span class="p">,</span><span class="s2">&quot;Dendroaspis&quot;</span><span class="p">,</span><span class="s2">&quot;Burnt Tayl&quot;</span><span class="p">,</span><span class="s2">&quot;Gladiator&quot;</span><span class="p">,</span>\
    <span class="s2">&quot;Argos&quot;</span><span class="p">,</span><span class="s2">&quot;Vulture&quot;</span><span class="p">,</span><span class="s2">&quot;Estoc&quot;</span><span class="p">,</span><span class="s2">&quot;Grimoire&quot;</span><span class="p">,</span><span class="s2">&quot;Gungnir&quot;</span><span class="p">,</span><span class="s2">&quot;GaeBolg&quot;</span><span class="p">,</span><span class="s2">&quot;Excalibur&quot;</span><span class="p">,</span><span class="s2">&quot;Durandal&quot;</span><span class="p">,</span><span class="s2">&quot;ClaiomhSolais&quot;</span><span class="p">,</span>\
<span class="s2">&quot;Caladbolg&quot;</span><span class="p">,</span><span class="s2">&quot;Balmung&quot;</span><span class="p">,</span><span class="s2">&quot;AmeNoMurakumo&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="cls">
<a class="viewcode-back" href="../server.html#server.cls">[docs]</a>
<span class="k">def</span> <span class="nf">cls</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction permettant de nettoyer la console</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="s1">&#39;clear&#39;</span><span class="p">)</span></div>


<span class="c1"># récupérer le pseudo à partir de la valeur &quot;socket&quot;</span>
<div class="viewcode-block" id="username">
<a class="viewcode-back" href="../server.html#server.username">[docs]</a>
<span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Une des méthodes permettant de récupérer le pseudo à partir de la valeur &quot;socket&quot;</span>
<span class="sd">    en parcourant un dictionnaire (normalement socket_list)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dictionary: le dictionnaire à parcourir</span>
<span class="sd">        value: la valeur à récupérer</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        key: la clé correspondant à la valeur</span>
<span class="sd">        or</span>
<span class="sd">        None: si la valeur n&#39;est pas trouvée</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span>
    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Ou retourner None</span></div>






<div class="viewcode-block" id="encrypt">
<a class="viewcode-back" href="../server.html#server.encrypt">[docs]</a>
<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span> <span class="c1"># pour automatiser encryption</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encrypter un payload donné en utilisant l&#39;algorithme de chiffrement AES.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        payload (bytes): Le payload à chiffrer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bytes: Le payload chiffré.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">))</span></div>


<div class="viewcode-block" id="decrypt">
<a class="viewcode-back" href="../server.html#server.decrypt">[docs]</a>
<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span> <span class="c1"># pour automatiser decryption</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decrypter un payload donné en utilisant l&#39;algorithme de chiffrement AES.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        payload (bytes): Le payload à déchiffrer.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Le payload déchiffré.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">AES</span><span class="o">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>



<div class="viewcode-block" id="user_sql_handler">
<a class="viewcode-back" href="../server.html#server.user_sql_handler">[docs]</a>
<span class="k">def</span> <span class="nf">user_sql_handler</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction essentielle permettant de gérer l&#39;authentification des utilisateurs.</span>
<span class="sd">    Elle gère à la fois la connexion et l&#39;inscription des utilisateurs.</span>
<span class="sd">    </span>
<span class="sd">    Les mots de passes ne sont pas entrés en clair dans la base de données, ils sont encryptés en utilisant l&#39;algorithme SHA256.</span>
<span class="sd">    Une limite de connexion est imposée par adresse ip (2 comptes max par ip).</span>
<span class="sd">    Une fois la connexion établie, les informations de l&#39;utilisateur sont restaurées depuis la base de données et insérées dans un dictionnaire (user_caps).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        user: le nom d&#39;utilisateur</span>
<span class="sd">        password: le mot de passe</span>
<span class="sd">        socket: le socket du client</span>
<span class="sd">        ip_address: l&#39;adresse ip du client</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        True: si l&#39;utilisateur est authentifié</span>
<span class="sd">        False: si l&#39;utilisateur n&#39;est pas authentifié</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        Error: si une erreur de connexion à la base de données est détectée</span>
<span class="sd">        IncorrectPassword: si le mot de passe est incorrect</span>
<span class="sd">        LimitConnectionIP: si la limite de connexion par ip est atteinte</span>
<span class="sd">        BannedUser: si l&#39;utilisateur est banni</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">current_user</span>
    <span class="n">password_salt</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="o">+</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">password_salt</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
            <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
        <span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM users WHERE username = </span><span class="si">%s</span><span class="s2"> AND password = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>

        <span class="c1"># Utilisez fetchone() pour récupérer une ligne du résultat</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="c1">#print(row)</span>
            
            <span class="c1"># requête spéciale permettant de vérifier si l&#39;utilisateur est banni dans la table sanction</span>
            <span class="n">special_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM sanction WHERE username = </span><span class="si">%s</span><span class="s2"> AND type = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">special_query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;ban&quot;</span><span class="p">))</span>
            <span class="n">special_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">special_row</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BannedUser</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vous avez été banni, veuillez contacter l&#39;administrateur</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">special_row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">special_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
        
            <span class="c1">#current_user = user_capabilities(row[0], row[3], row[2])</span>
            <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_capabilities</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Utilisateur trouvé, restauration de ses données...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># nouvelle requête pour vérifier occurence de l&#39;ip si &gt; 2 alors pass</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM users WHERE ip = </span><span class="si">%s</span><span class="s2"> OR ip = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">))</span>
            <span class="c1">#print(ip_address)</span>
            
            <span class="n">ip_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="c1">#print(ip_row)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># 2 comptes max par ip</span>
                <span class="k">raise</span> <span class="n">LimitConnectionIP</span><span class="p">(</span><span class="s2">&quot;Vous avez atteint la limite de connexion sur cette adresse ip&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>     
            
                <span class="n">second_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM users WHERE username = </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">second_query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">IncorrectPassword</span><span class="p">(</span><span class="s2">&quot;Utilisateur trouvé, mais le mot de passe est incorrect&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Utilisateur non trouvé, création d&#39;un nouvel utilisateur...&quot;</span><span class="p">)</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO users (username, password, allowed_room, ip) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;General&quot;</span><span class="p">),</span> <span class="n">host</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_capabilities</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;General&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># pour nouveau utilisateur</span>
            <span class="c1">#user_caps[socket] = user_capabilities(user, password, str(&quot;General&quot;)) # pour nouveau utilisateur </span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">IncorrectPassword</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1">#socket.send(f&quot;{e}&quot;.encode())   </span>
        <span class="c1">#print(&quot;Compta banni&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">LimitConnectionIP</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1">#socket.send(f&quot;{e}&quot;.encode())   </span>
        <span class="c1">#print(&quot;Compta banni&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">except</span> <span class="n">BannedUser</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>   
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Compta banni&quot;</span><span class="p">)</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

            
<div class="viewcode-block" id="update_userinfo_sql">
<a class="viewcode-back" href="../server.html#server.update_userinfo_sql">[docs]</a>
<span class="k">def</span> <span class="nf">update_userinfo_sql</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">socket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction essentielle permettant la mise à jour des informations dans la base de données suite à l&#39;éxécution de commandes.</span>
<span class="sd">    Pour aller plus loin, elle permet de mettre à jour le contexte autours des utilisateurs (salons autorisés, droits d&#39;administrateur, etc...)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        user: le nom d&#39;utilisateur</span>
<span class="sd">        value: la valeur à mettre à jour</span>
<span class="sd">        reason: la raison de la mise à jour</span>
<span class="sd">        socket: le socket du client</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        Exception: si la raison n&#39;est pas valide (upgrade, roomupdate, password, roomdowngrade, kick, ban, query_insert, query_update)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement (pas si sensible)</span>
            <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement (exemple de mot de passe)</span>
        <span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE users SET is_admin = </span><span class="si">%s</span><span class="s2"> WHERE username = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;roomupdate&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE users SET allowed_room = </span><span class="si">%s</span><span class="s2"> WHERE username = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE users SET password = </span><span class="si">%s</span><span class="s2"> WHERE username = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;roomdowngrade&quot;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE users SET allowed_room = </span><span class="si">%s</span><span class="s2"> WHERE username = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="n">reason</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;query_insert&quot;</span><span class="p">):</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;!&quot;</span> <span class="ow">in</span> <span class="n">reason</span> <span class="k">else</span> <span class="n">reason</span>
            <span class="k">if</span> <span class="s2">&quot;!&quot;</span> <span class="ow">in</span> <span class="n">reason</span><span class="p">:</span>
                <span class="nb">type</span><span class="p">,</span> <span class="n">reason_query</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># récupérer type sanction et le motif</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">reason_query</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="k">if</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s2">&quot;server&quot;</span> <span class="ow">in</span> <span class="n">reason_query</span><span class="p">:</span>
                <span class="n">is_accept</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_accept</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="n">rooms</span> <span class="o">=</span> <span class="n">value</span>
                
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO query (username, type, rooms, reason, is_accept) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
                <span class="k">if</span> <span class="n">reason_query</span> <span class="k">else</span> <span class="s2">&quot;INSERT INTO query (username, type, rooms, is_accept) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
                
            <span class="k">if</span> <span class="n">reason_query</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">rooms</span><span class="p">,</span> <span class="n">reason_query</span><span class="p">,</span> <span class="n">is_accept</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">rooms</span><span class="p">,</span> <span class="n">is_accept</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
        <span class="k">elif</span> <span class="n">reason</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;query_update&quot;</span><span class="p">):</span>
            <span class="nb">id</span><span class="p">,</span> <span class="n">update_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            
            
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;UPDATE query SET is_accept = </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">update_value</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            <span class="c1"># récupérer le champs type de query et crafter la réponse à envoyer</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM query WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        
                        <span class="n">target_socket</span> <span class="o">=</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        
                        <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;roomupdate&quot;</span><span class="p">,</span> <span class="n">target_socket</span><span class="p">)</span>
                        <span class="n">target_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;scb:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Votre demande a été acceptée&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">target_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;scb:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Votre demande a été refusée ou vous ne disposer pas des droits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
                
        <span class="k">elif</span> <span class="n">reason</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ban&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">reason</span><span class="p">:</span>
                <span class="nb">type</span><span class="p">,</span> <span class="n">reason_k</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># récupérer type sanction et le motif</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">reason_k</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO sanction(username,reason,type) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
                <span class="k">if</span> <span class="n">reason_k</span> <span class="k">else</span> <span class="s2">&quot;INSERT INTO sanction(username,type) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
                
            <span class="k">if</span> <span class="n">reason_k</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">reason_k</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">type</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            
            
            
            
        <span class="k">elif</span> <span class="s2">&quot;kick&quot;</span> <span class="ow">in</span> <span class="n">reason</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">reason</span><span class="p">:</span>
                <span class="nb">type</span><span class="p">,</span> <span class="n">reason_k</span> <span class="o">=</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reason</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># récupérer type sanction et le motif</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">reason</span>
                <span class="n">reason_k</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># pas de motif donné (non obligatoire)</span>

            <span class="n">room</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">date_debut</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">date_final</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO sanction(username,rooms,reason,type,start_date,end_date) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> \
                <span class="k">if</span> <span class="n">reason_k</span> <span class="k">else</span> <span class="s2">&quot;INSERT INTO sanction(username,rooms,type,start_date,end_date) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>

            <span class="k">if</span> <span class="n">reason_k</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="n">reason_k</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">date_debut</span><span class="p">,</span> <span class="n">date_final</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">date_debut</span><span class="p">,</span> <span class="n">date_final</span><span class="p">))</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;La raison n&#39;est pas valide (upgrade, roomupdate, password, roomdowngrade, kick, ban, query_insert, query_update)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    </div>

            
            
<span class="c1"># Fonction pour envoyer des messages</span>
<div class="viewcode-block" id="Send">
<a class="viewcode-back" href="../server.html#server.Send">[docs]</a>
<span class="k">def</span> <span class="nf">Send</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction permettant d&#39;envoyer des messages.</span>
<span class="sd">    Elle gère également les commandes administrateurs et les requêtes sql.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        socket: le socket du client</span>
<span class="sd">        host: l&#39;hôte du serveur</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">       None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        ConnectionResetError: si la connexion est interrompue par le client</span>
<span class="sd">        OSError: si le socket est fermé</span>
<span class="sd">        LogoutBroadcast: si le serveur envoie un message de déconnexion général</span>
<span class="sd">        Exception: si la commande n&#39;est pas valide    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#global hostup</span>
    <span class="k">global</span> <span class="n">connected</span>
    <span class="k">global</span> <span class="n">socket_list</span>
    <span class="n">hostup</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">while</span> <span class="n">hostup</span><span class="p">:</span>
        
        <span class="c1">#enlever du dictionnaire socket_list les sockets [closed]</span>
        <span class="k">for</span> <span class="n">user_selected</span><span class="p">,</span> <span class="n">socket_selected</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">socket_list</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span> <span class="c1"># on utilise list pour éviter les erreurs de modification de taille </span>
            <span class="k">if</span> <span class="n">bt</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">socket_selected</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="c1"># ça veut dire que le socket est fermé</span>
                <span class="n">user_selected</span><span class="p">,</span> <span class="n">socket_selected</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
                     
        <span class="k">try</span><span class="p">:</span>    
            <span class="n">msg</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;server@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> $:&quot;</span><span class="p">)</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1A</span><span class="se">\033</span><span class="s2">[2K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># up + clear line</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;you: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socket_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;bye&quot;</span><span class="p">:</span> <span class="c1"># dans le cas où il y a plusieurs clients</span>
                <span class="k">raise</span> <span class="n">LogoutBroadcast</span><span class="p">(</span><span class="s2">&quot;Attention vous vous apprêtez à envoyer un message de déconnexion à tous les clients&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/deop&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">,</span><span class="s2">&quot;/op&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;bye&quot;</span><span class="p">,</span> <span class="s2">&quot;/kick&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;/ban&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;arret&quot;</span><span class="p">,</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span> 
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socket_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># envoyer à tous les clients</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="n">user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le socket </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> n&#39;existe plus&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La connexion a été interrompue par le client&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># quand le socket est fermé</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">LogoutBroadcast</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c1"># un avertissement (non punitif)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s2">&quot; voici la bonne syntaxe ex: </span><span class="se">\&quot;</span><span class="s2">bye arnaud</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> \
                <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>

            
            <span class="k">if</span> <span class="s2">&quot;bye&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target_socket</span> <span class="o">=</span> <span class="n">socket_list</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="c1"># essaie de récupérer le socket avec le username</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le pseudo </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> n&#39;existe pas </span><span class="se">\n</span><span class="s2"> ou l&#39;utilisateur n&#39;est pas connecté&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;bye&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="n">username</span><span class="p">,</span> <span class="n">target_socket</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                    <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
                   
            <span class="k">if</span> <span class="s2">&quot;/kick&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg_d</span> <span class="o">:=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
                
                <span class="n">time_delimiter</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]</span>
                
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;kick&quot;</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le pseudo </span><span class="si">{</span><span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">user_capabilities</span><span class="o">.</span><span class="n">all_rooms</span> <span class="ow">and</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;ALL&quot;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le salon </span><span class="si">{</span><span class="n">msg_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">user</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">rooms</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">reasons</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">time_delimiter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                                <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0h&quot;</span> <span class="o">+</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">time_delimiter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;0m&quot;</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">time_delimiter</span><span class="p">:</span>
                            <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            
                            <span class="n">time_matrix</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">time_matrix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="c1"># dans le cas où on a 1h, 1h30m etc...</span>
                                <span class="n">time_matrix</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            
                            <span class="n">time_debut</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                            <span class="n">time_fin</span> <span class="o">=</span>  <span class="n">time_debut</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">time_matrix</span><span class="p">,[</span><span class="mi">3600</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">1</span><span class="p">])])</span>
                            <span class="n">date_debut</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time_debut</span><span class="p">)</span>
                            <span class="n">date_fin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time_fin</span><span class="p">)</span>
                            
                            
                            <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rooms</span><span class="si">}</span><span class="s1">!</span><span class="si">{</span><span class="n">date_debut</span><span class="si">}</span><span class="s1">!</span><span class="si">{</span><span class="n">date_fin</span><span class="si">}</span><span class="s1">&#39;</span>\
                                <span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;kick:</span><span class="si">{</span><span class="n">reasons</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;kick&#39;</span><span class="si">}</span><span class="s2">&quot;</span>\
                                    <span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="p">)</span>
                            
                            <span class="c1"># log dans query_insert</span>
                            <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rooms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query_insert:</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">!server&quot;</span><span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>  
                            <span class="k">if</span> <span class="n">rooms</span> <span class="o">==</span> <span class="s1">&#39;ALL&#39;</span><span class="p">:</span>
                                <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bye&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                                <span class="n">user</span><span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                                <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
                                
                            <span class="k">elif</span> <span class="n">rooms</span> <span class="o">==</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]]</span><span class="o">.</span><span class="n">current_room</span><span class="p">:</span>
                                <span class="n">user_caps</span><span class="p">[</span><span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">=</span> <span class="s2">&quot;General&quot;</span>
                                <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jn: Succès:General&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jn: Succès:General&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                                
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span><span class="s2">&quot;Le format de la commande est incorrect :</span><span class="se">\n</span><span class="s2">ex: /kick [pseudo] [rooms|ALL] 1h30 [reasons]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/ban&quot;</span><span class="p">):</span>
                <span class="n">msg_d</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ban&quot;</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le pseudo </span><span class="si">{</span><span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> n&#39;existe pas&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">user</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">reasons</span> <span class="o">=</span> <span class="n">msg_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>
                        
                        <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="kc">None</span>\
                                <span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39;ban:</span><span class="si">{</span><span class="n">reasons</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">reasons</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;ban&#39;</span><span class="si">}</span><span class="s2">&quot;</span>\
                                    <span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="p">)</span>
                        
                        <span class="c1"># log dans query_insert </span>
                        <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_caps</span><span class="p">[</span><span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]]</span><span class="o">.</span><span class="n">all_rooms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query_insert:</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">!server&quot;</span><span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
                        
                        <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bye&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                        <span class="n">user</span><span class="p">,</span> <span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
                        <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
                    
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span><span class="p">,</span><span class="s2">&quot;Le format de la commande est incorrect :</span><span class="se">\n</span><span class="s2">ex: /ban [pseudo] [reasons](optional)&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            
            
            
            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;/kill&quot;</span><span class="p">:</span>
                
                <span class="k">for</span> <span class="n">a_socket</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">a_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bye&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="n">a_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    
                <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">server_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/op&quot;</span><span class="p">):</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
                
                
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/deop&quot;</span><span class="p">):</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/users&quot;</span><span class="p">):</span>
                <span class="n">available_users</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="bp">cls</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">available_users</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">user_caps</span><span class="p">[</span><span class="n">socket_list</span><span class="p">[</span><span class="n">user</span><span class="p">]]</span><span class="o">.</span><span class="n">current_room</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">server@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1"> $:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="kc">None</span>
                
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/accept&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/refuse&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">value_send</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/accept&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_send</span><span class="p">,</span> <span class="s2">&quot;query_update&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="c1"># le user et socket correspondants seront récupérés suite à une requête sql</span>
                    
                    <span class="c1"># si le message contenait un /refuse alors supprimer la requête de la base de donnée</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/refuse&quot;</span><span class="p">):</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                                <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                                <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                            <span class="p">)</span>
                            <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM query WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],))</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;La commande n&#39;est pas valide, veuillez réessayer</span><span class="se">\n</span><span class="s2">syntaxe : /accept [id]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/query&quot;</span><span class="p">):</span>
                <span class="c1"># afficher toutes les query de la table query</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                    <span class="p">)</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM query&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    <span class="c1"># Utilisez fetchone() pour récupérer une ligne du résultat</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">while</span> <span class="n">row</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="s2">&quot;/unsubscribe&quot;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg_d</span><span class="o">:=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg_d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">username_s</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                    
                    <span class="n">target_socket_s</span> <span class="o">=</span> <span class="n">socket_list</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username_s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket_s</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">==</span> <span class="n">room</span><span class="p">:</span> <span class="c1"># pour éviter des conflits (forcé côté client également)</span>
                            <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket_s</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">=</span> <span class="s2">&quot;General&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">new_room</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket_s</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="o">==</span> <span class="n">room</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;La commande n&#39;est pas valide, veuillez réessayer</span><span class="se">\n</span><span class="s2">syntaxe : /unsubscribe [user] [room]&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket_s</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="p">):</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username_s</span><span class="p">,</span> <span class="n">new_room</span><span class="p">,</span> <span class="s2">&quot;roomdowngrade&quot;</span><span class="p">,</span> <span class="n">target_socket_s</span><span class="p">)</span>
                    <span class="n">target_socket_s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;us: Vous avez été désabonné de la room </span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="s2">&quot;L&#39;utilisateur ciblé n&#39;est pas inscrit à ce salon&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># Fonction pour recevoir des messages</span>
<div class="viewcode-block" id="receive">
<a class="viewcode-back" href="../server.html#server.receive">[docs]</a>
<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction permettant de gérer la réception de messages.</span>
<span class="sd">    Elle gère également les commandes administrateurs et les requêtes sql.</span>
<span class="sd">    Elle gère aussi le broadcast des messages reçus aux utilisateurs connectés (dans le même salon).</span>
<span class="sd">    </span>
<span class="sd">    Elle enregistre les messages dans la base de données.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        socket: le socket du client</span>
<span class="sd">        host: l&#39;hôte du serveur</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        ConnectionResetError: si la connexion est interrompue par le client</span>
<span class="sd">        ConnectionAbortedError: si la connexion est interrompue par le serveur</span>
<span class="sd">        OSError: si le socket est fermé</span>
<span class="sd">        Exception: si la commande n&#39;est pas valide</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">connected</span>
    <span class="n">hostup</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">while</span> <span class="n">hostup</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ConnectionResetError</span><span class="p">:</span>
            
            <span class="c1">#enlever username et socket de socket_list</span>
            <span class="n">socket_list</span><span class="p">[</span><span class="n">socket</span><span class="p">],</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            
            <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La connexion a été interrompue par le client&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">ConnectionAbortedError</span><span class="p">:</span>
            
            <span class="c1">#enlever username et socket de socket_list</span>
            <span class="n">socket_list</span><span class="p">[</span><span class="n">socket</span><span class="p">],</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
            
            <span class="n">hostup</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(rcv)Le serveur a fermé sa connexion&quot;</span><span class="p">)</span>
            <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">if</span> <span class="n">bt</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">==</span> <span class="n">socket</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># liste qui contient tous les entêtes de réponses à une commande</span>
            <span class="c1"># elle est utilisée pour éviter que les clients envoient des fausses réponses à une commande</span>
            <span class="n">list_header</span> <span class="o">=</span> <span class="p">[</span><span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fwd&quot;</span><span class="p">),</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;us&quot;</span><span class="p">),</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;jn&quot;</span><span class="p">),</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;scb&quot;</span><span class="p">),</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">),</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cmd&quot;</span><span class="p">)]</span>
            <span class="n">forward_condition</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">list_header</span><span class="p">))</span>
            
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[2K&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> &quot;</span><span class="p">)</span>  <span class="c1"># carriage return + clear </span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span><span class="n">socket</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">reply</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">reply</span> <span class="ow">and</span> <span class="n">reply</span> <span class="k">else</span> <span class="kc">None</span>
            
            
            
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">reply</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;bye&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;/kill&quot;</span> <span class="ow">and</span> <span class="n">reply</span> <span class="ow">and</span> <span class="n">forward_condition</span><span class="p">:</span>
                
                <span class="c1"># cette section servira à l&#39;insertion des messages dans la table channel de la base de donnée</span>
                <span class="n">m_username</span> <span class="o">=</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">username</span>
                <span class="n">m_rooms</span> <span class="o">=</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">all_rooms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">m_rooms</span><span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">reply</span>
                
                <span class="c1"># Cette variable contient les sockets des clients qui sont dans la même room que le client actuel</span>
                <span class="n">target_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">if</span> \
                    <span class="p">(</span><span class="n">user_caps</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">==</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span><span class="p">)</span>  \
                        <span class="ow">and</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">socket</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            
                <span class="k">for</span> <span class="n">user_target</span> <span class="ow">in</span> <span class="n">target_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">user_target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fwd:</span><span class="si">{</span><span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span><span class="n">socket</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">reply</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> \
                            <span class="k">if</span> <span class="n">user_target</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">Fore</span><span class="o">.</span><span class="n">RED</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Le socket </span><span class="si">{</span><span class="n">user_target</span><span class="si">}</span><span class="s2"> n&#39;existe plus&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">RESET</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                
                
                <span class="k">try</span><span class="p">:</span> <span class="c1"># tentative d&#39;insertion dans la base de données</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                    <span class="p">)</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO channel (id, rooms, users, content) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">m_rooms</span><span class="p">,</span> <span class="n">m_username</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
                
                <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
            <span class="c1"># Vérifie si la réponse commence par &quot;query:&quot; et que l&#39;utilisateur contenu dans la réponse est un administrateur</span>
            <span class="c1"># Le premier dictionnaire socket_list est utilisé pour récupérer le socket de l&#39;administrateur</span>
            <span class="c1"># Le second dictionnaire user_caps est utilisé pour récupérer les droits de l&#39;administrateur (via la classe user_capabilities)</span>
            
            <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/query:&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user_caps</span><span class="p">[</span><span class="n">socket_list</span><span class="p">[</span><span class="n">q_user</span><span class="o">:=</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">is_admin</span> \
                <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">):</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                        <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                        <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                    <span class="p">)</span>
                    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM query&quot;</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                    
                    <span class="nb">all</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                    
                    <span class="nb">all</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">])</span>

                    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query:</span><span class="si">{</span><span class="nb">all</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                   
                <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        
            <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/accept:&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/refuse:&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">q_socket</span><span class="o">:=</span><span class="n">socket_list</span><span class="p">[</span><span class="n">q_user</span><span class="o">:=</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]]</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
                <span class="n">value_send</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/accept&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">value_send</span><span class="p">,</span> <span class="s2">&quot;query_update&quot;</span><span class="p">,</span> <span class="n">q_socket</span><span class="p">)</span> <span class="c1"># le user et socket correspondants seront récupérés suite à une requête sql</span>

                <span class="c1"># si le message contenait un /refuse alors supprimer la requête de la base de donnée</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/refuse&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                            <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                            <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                        <span class="p">)</span>
                        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM query WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">],))</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;/kill&quot;</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;/rooms&quot;</span><span class="p">:</span>
                <span class="c1"># Cette variable contient les rooms disponibles et ajoute le flag alw: si le client possède un accès à la room </span>
                <span class="n">available_rooms</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;alw:</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span> \
                    <span class="k">else</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">all_rooms</span> <span class="p">])</span> 
                <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;cmd:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">available_rooms</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                
            <span class="k">if</span> <span class="n">reply</span> <span class="o">==</span> <span class="s2">&quot;/users&quot;</span><span class="p">:</span>
                <span class="c1"># Cette variable contient les users connectés et ajoute le flag alw: si le client possède un accès à la room </span>
                <span class="n">available_users</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">socket_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> 
                <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;users:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">available_users</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                
            <span class="k">if</span> <span class="s2">&quot;/subscribe&quot;</span> <span class="ow">in</span> <span class="n">reply</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="kc">None</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">all_rooms</span> <span class="ow">and</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">room</span> <span class="o">==</span> <span class="s2">&quot;Blabla&quot;</span><span class="p">):</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span><span class="n">socket</span><span class="p">),</span> <span class="n">room</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query_insert:subscribe!server&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span><span class="n">socket</span><span class="p">),</span> <span class="n">room</span><span class="p">,</span> <span class="s2">&quot;roomupdate&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;scb:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Votre demande a été acceptée&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    
                <span class="k">elif</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">all_rooms</span><span class="p">):</span>
                    <span class="bp">cls</span><span class="p">()</span>
                    <span class="c1"># log dans query_insert</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span><span class="n">socket</span><span class="p">),</span> <span class="n">room</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;query_insert:subscribe!</span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
                      
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;scb:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;Votre demande a été refusée ou vous ne disposer pas des droits&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                
            <span class="k">if</span> <span class="s2">&quot;/join&quot;</span> <span class="ow">in</span> <span class="n">reply</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="p">):</span>
                    
                    <span class="c1"># faire une requête sql vers la table sanction et vérifie si le user n&#39;est pas kick du salon</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
                            <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                            <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
                        <span class="p">)</span>
                        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
                        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM sanction WHERE username = </span><span class="si">%s</span><span class="s2"> AND rooms = </span><span class="si">%s</span><span class="s2"> AND type = </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="s2">&quot;kick&quot;</span><span class="p">))</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                            <span class="n">date_fin_v1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                            <span class="n">date_fin</span> <span class="o">=</span> <span class="n">date_fin_v1</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">date_fin</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date_fin_v1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jn: Vous avez été kick de la room </span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2"> time:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                        
                        <span class="k">continue</span>
                        
                    
                    
                    <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">=</span> <span class="n">room</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jn: Succès:</span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="n">restore_old_messages</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;jn: Vous ne disposez pas d&#39;accès au salon </span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">, veuillez vous y souscrire..&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    
            <span class="k">if</span> <span class="s2">&quot;/unsubscribe&quot;</span> <span class="ow">in</span> <span class="n">reply</span><span class="p">:</span> <span class="c1"># à update pour sélectionner le bon user</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">username_r</span> <span class="o">=</span> <span class="n">username</span><span class="p">(</span><span class="n">socket_list</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    
                    <span class="n">target_socket</span> <span class="o">=</span> <span class="n">socket</span>
                    
                    <span class="k">if</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">==</span> <span class="n">room</span><span class="p">:</span> <span class="c1"># pour éviter des conflits (forcé côté client également)</span>
                        <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span> <span class="o">=</span> <span class="s2">&quot;General&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
                    
                    <span class="n">new_room</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span> <span class="o">==</span> <span class="n">room</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">room</span> <span class="o">=</span> <span class="kc">None</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="ow">in</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">target_socket</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="p">):</span>
                    <span class="n">update_userinfo_sql</span><span class="p">(</span><span class="n">username_r</span><span class="p">,</span> <span class="n">new_room</span><span class="p">,</span> <span class="s2">&quot;roomdowngrade&quot;</span><span class="p">,</span> <span class="n">target_socket</span><span class="p">)</span>
                    <span class="n">target_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;us: Vous avez été désabonné de la room </span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;us: Vous ne disposez pas d&#39;accès au salon </span><span class="si">{</span><span class="n">room</span><span class="si">}</span><span class="s2">, veuillez vous y souscrire..&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    
            <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span> <span class="c1"># commande sans output</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;server@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1"> $:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">reply</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reply</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">server@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1"> $:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kc">None</span>
            <span class="n">reply</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># le si le type est str ça signifie que le socket est déjà fermé</span></div>



<div class="viewcode-block" id="restore_old_messages">
<a class="viewcode-back" href="../server.html#server.restore_old_messages">[docs]</a>
<span class="k">def</span> <span class="nf">restore_old_messages</span><span class="p">(</span><span class="n">socket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cette fonction permet de récupérer la totalité des messages d&#39;un salon donné.</span>
<span class="sd">    Elle est utilisée lorsqu&#39;un utilisateur rejoint un salon.</span>
<span class="sd">    Elle récupère les messages depuis la base de données.</span>
<span class="sd">    Et les envoie à l&#39;utilisateur.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        socket: le socket du client</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        Error: si la connexion à la base de données échoue</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="s1">&#39;seleenix&#39;</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
            <span class="n">password</span><span class="o">=</span><span class="n">mysql_passwd</span>  <span class="c1"># récupéré depuis var d&#39;environnement</span>
        <span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM channel&quot;</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># Utilisez fetchone() pour récupérer une ligne du résultat</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">user_caps</span><span class="p">[</span><span class="n">socket</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">#socket.send(f&quot;old:{row[2]}:{row[3]}&quot;.encode())</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c1"># envoie tous les messages à l&#39;utilisateur    </span>
        <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;old:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> \
            <span class="k">if</span> <span class="n">messages</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Erreur de connexion à la base de données&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_ip">
<a class="viewcode-back" href="../server.html#server.get_ip">[docs]</a>
<span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction utilisant un socket afin d&#39;initier une connexion vers 8.8.8.8</span>
<span class="sd">    et récupérer l&#39;adresse IP de l&#39;interface utilisée.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: L&#39;adresse IP de l&#39;interface.</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        Exception: Si la connexion échoue.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># récupérer l&#39;adresse ip de l&#39;interface</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span></div>



<span class="c1"># Cette fonction a été en partie générée par ChatGPT</span>
<div class="viewcode-block" id="get_interface_name_by_ip">
<a class="viewcode-back" href="../server.html#server.get_interface_name_by_ip">[docs]</a>
<span class="k">def</span> <span class="nf">get_interface_name_by_ip</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction générée par ChatGPT permettant de récupérer nom </span>
<span class="sd">    d&#39;une interface active</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ip_address (str): L&#39;adresse IP de l&#39;interface.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: Le nom de l&#39;interface.</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Utiliser socket pour résoudre le nom d&#39;hôte associé à l&#39;adresse IP</span>
        <span class="n">hostname</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>

        <span class="c1"># Utiliser psutil pour obtenir les informations sur les interfaces réseau</span>
        <span class="k">for</span> <span class="n">interface</span><span class="p">,</span> <span class="n">addrs</span> <span class="ow">in</span> <span class="n">psutil</span><span class="o">.</span><span class="n">net_if_addrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">addr</span><span class="o">.</span><span class="n">address</span> <span class="o">==</span> <span class="n">ip_address</span> <span class="ow">or</span> <span class="n">addr</span><span class="o">.</span><span class="n">address</span> <span class="o">==</span> <span class="n">hostname</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">interface</span>

        <span class="c1"># Si aucune correspondance n&#39;est trouvée</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">herror</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="c1"># Gérer les erreurs en cas de résolution d&#39;adresse IP ou si l&#39;adresse IP n&#39;est pas trouvée dans les interfaces</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="send_announcement">
<a class="viewcode-back" href="../server.html#server.send_announcement">[docs]</a>
<span class="k">def</span> <span class="nf">send_announcement</span><span class="p">(</span><span class="n">server_port</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cette fonction permet d&#39;envoyer dans le réseau local un message UDP</span>
<span class="sd">    afin d&#39;annoncer la présence du serveur. (et ses informations)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        server_port: le port du serveur</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">ip</span> <span class="o">=</span> <span class="n">get_ip</span><span class="p">()</span>
    <span class="n">ifname</span> <span class="o">=</span>  <span class="n">get_interface_name_by_ip</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">connected</span><span class="p">:</span>
        <span class="n">pkt</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">src</span><span class="o">=</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="s2">&quot;255.255.255.255&quot;</span><span class="p">)</span>\
            <span class="o">/</span><span class="n">UDP</span><span class="p">(</span><span class="n">sport</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>\
                <span class="o">/</span><span class="n">Raw</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="s2">&quot;Server announcement:port:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server_port</span><span class="p">))</span>
        <span class="n">send</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="n">ifname</span><span class="p">)</span> <span class="c1"># cette fonction est différente de celle du tchat , c&#39;est celle de scapy !</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Envoyer l&#39;annonce toutes les 0.5 secondes</span>
    <span class="k">return</span> <span class="mi">0</span></div>

<span class="c1"># Fonction pour l&#39;interaction avec le client</span>
<div class="viewcode-block" id="interactive">
<a class="viewcode-back" href="../server.html#server.interactive">[docs]</a>
<span class="k">def</span> <span class="nf">interactive</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fonction permettant d&#39;initier le mode interactif avec le client.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        target: le socket du client</span>
<span class="sd">        host: l&#39;hôte du serveur</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">        </span>
<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">connected</span>
    <span class="k">global</span> <span class="n">socket_list</span>
    <span class="c1">#connected = True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected to client&quot;</span><span class="p">)</span>
    <span class="n">restore_old_messages</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>    
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">receive</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">host</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socket_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Send</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span> 
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span> <span class="c1">#if not connected else None</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Point d&#39;entrée du programme serveur. (si éxécuté en tant que script)</span>
<span class="sd">    </span>
<span class="sd">    Il créé le socket du serveur et attend les connexions des clients.</span>
<span class="sd">    Il gère également les connexions des clients. (dans une boucle d&#39;acceptation)</span>
<span class="sd">    Il gère la vérification du challenge envoyé par le client.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">arg_parse</span><span class="p">()</span><span class="o">.</span><span class="n">port</span>
    
    <span class="c1"># Création du socket serveur</span>
    <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    
    <span class="n">conf</span><span class="o">.</span><span class="n">verb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Pour ne pas afficher les messages de scapy</span>
    <span class="c1"># Afin d&#39;annonce le serveur sur le réseau, on envoie un message UDP</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">send_announcement</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">((</span><span class="n">port</span><span class="p">),))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>



    <span class="c1"># Boucle principale d&#39;attente de connexions</span>
    <span class="k">while</span> <span class="n">connected</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
            <span class="n">message_1</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le message n&#39;a pas pu être déchiffré&quot;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;garbage&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">message_1</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;garbage&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#message_2 = conn.recv(1024).decode()</span>
                <span class="n">client_challenge</span><span class="p">,</span> <span class="n">credentials</span> <span class="o">=</span> <span class="n">message_1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">message_1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">connect_condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">client_condition</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">connect_condition</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">client_challenge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">client_condition</span><span class="p">:</span>
                <span class="n">unique_pseudo</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">default_pseudo</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span> \
                        <span class="k">else</span> <span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># choisir un pseudo unique si pas de user dans credentials</span>
                <span class="n">is_auth</span> <span class="o">=</span> <span class="n">user_sql_handler</span><span class="p">(</span><span class="n">unique_pseudo</span><span class="p">,</span> <span class="n">credentials</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">conn</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
                <span class="c1"># ajouter au dictionnaire socket_list une entrée avec clé le pseudonyme et comme valeur le socket</span>
                <span class="k">if</span> <span class="n">is_auth</span><span class="p">:</span>
                    <span class="n">socket_list</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unique_pseudo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;synced,</span><span class="si">{</span><span class="n">unique_pseudo</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">user_caps</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;GUI&quot;</span> <span class="ow">in</span> <span class="n">message_1</span> \
                        <span class="k">else</span> <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;synced:</span><span class="si">{</span><span class="n">unique_pseudo</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_caps</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="o">.</span><span class="n">current_room</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">user_caps</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="o">.</span><span class="n">allowed_room</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">host</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="c1">#interactive(conn, host)</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;garbage&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#server_socket.close()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Droits d'auteur 2023, iPresing.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>